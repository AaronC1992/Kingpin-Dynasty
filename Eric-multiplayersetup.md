Eric - Multiplayer Server Setup & Diagnostic Guide (for Eric)

Purpose
-------
This guide is written for Eric — the person responsible for uploading files, configuring the website, and ensuring the multiplayer server runs on the website backend. It contains exact copy/paste commands and config blocks to start the Node server, verify it is reachable, proxy WebSocket upgrades through nginx, enable TLS, and verify the client connects with `wss://`.

Top-level quick checklist for Eric (copy/paste)
-----------------------------------------------
1. Place the repo files on the server in a directory (e.g. `/var/www/kingpin`).
2. Install Node and dependencies:
   - `cd /var/www/kingpin`
   - `npm install`
3. Start server to test:
   - `PORT=3000 node server.js` (Linux/Mac)
   - or `set PORT=3000 && node server.js` (Windows cmd)
4. Confirm HTTP & health endpoints:
   - `curl -I http://127.0.0.1:3000/`  (should return 200)
   - `curl -s http://127.0.0.1:3000/health | jq` (should return JSON status)
5. If using nginx, add the provided nginx site config and reload nginx.
6. If serving HTTPS, enable certbot/Let's Encrypt (certbot --nginx) so client uses `wss://`.
7. Open the game page and paste the two console lines printed by the client: `[multiplayer] Resolved serverUrl -> ...` and `[multiplayer] Connecting to WebSocket server at ...` and any WebSocket errors.

Why these steps
----------------
- `server.js` provides both static file serving (the game) and a WebSocket server for multiplayer. Both must be reachable.
- When the site is HTTPS, WebSocket must use `wss://` and the reverse proxy must forward Upgrade headers.
- The client now logs the resolved server URL; use those logs to confirm the client is attempting the correct hostname/protocol.

A. Systemd unit (copy/paste)
----------------------------
If you want the server to run continuously and restart on failure, use this systemd unit. Save it as `/etc/systemd/system/kingpin-server.service` and then `systemctl daemon-reload` and `systemctl enable --now kingpin-server`.

Copy/paste systemd unit:

```
[Unit]
Description=Kingpin Dynasty multiplayer server
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/var/www/kingpin
Environment=PORT=3000
ExecStart=/usr/bin/node server.js
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
```

Adjust `User` and `WorkingDirectory` to match your server.

B. Procfile (for Heroku/Railway)
--------------------------------
If deploying to Heroku or Railway, add a `Procfile` with this content in the repo root.

```
web: node server.js
```

C. nginx site config (copy/paste)
---------------------------------
Use this for nginx to serve the site and proxy WebSocket upgrade headers. Put it in `/etc/nginx/sites-available/kingpin` and symlink to `sites-enabled`.

```
server {
    listen 80;
    server_name your.domain.com;  # replace with real domain

    # Redirect HTTP to HTTPS (if using certbot you'll have separate HTTPS block)
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name your.domain.com;

    # TLS cert paths generated by certbot
    ssl_certificate /etc/letsencrypt/live/your.domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your.domain.com/privkey.pem;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

Important: the `proxy_set_header Upgrade` and `Connection "Upgrade"` lines are required for WebSocket support.

D. Health checks & quick tests (copy/paste)
-------------------------------------------
Run these on the server to confirm the server process and endpoints are available:

- Check Node process:
```
ps aux | grep node
```

- Check port listening (Linux):
```
ss -ltnp | grep 3000
# or
netstat -tulpn | grep 3000
```

- Simple curl tests (from server or remote):
```
curl -I http://127.0.0.1:3000/
curl -s http://127.0.0.1:3000/health | jq
curl -I https://your.domain.com/   # check public site
curl -s https://your.domain.com/health | jq
```

- WebSocket quick test from server (install wscat):
```
npm i -g wscat
wscat -c ws://127.0.0.1:3000    # non-TLS test
wscat -c wss://your.domain.com   # TLS test once domain + TLS configured
```

E. Client override if WebSocket server is on another host
---------------------------------------------------------
If the WebSocket server will be hosted on a different host than the site, add this snippet inside the `<head>` of `index.html` before any script tags that load `multiplayer.js`:

```
<script>
  // Override the multiplayer server URL - REQUIRED if WebSocket server is separate
  window.__MULTIPLAYER_SERVER_URL__ = 'wss://ws.your-domain.com';
</script>
```

F. What to capture from browser and server (paste back to developer)
--------------------------------------------------------------------
1. Browser Console lines:
   - `[multiplayer] Resolved serverUrl -> <url>`
   - `[multiplayer] Connecting to WebSocket server at <url>`
   - Any WebSocket error messages (exact text from Console or Network ? WS)
2. Server logs (systemd journal or Node console) around the time the browser loads the page.
   - `journalctl -u kingpin-server -f` (if using systemd)
   - Or copy the terminal running `node server.js` output
3. nginx site config if using a proxy.

G. Common error diagnostics & fixes (copy/paste commands)
-------------------------------------------------------
- ERR_CONNECTION_REFUSED -> Server not running or firewall blocked. Start server and open firewall port:
```
# start server (example)
cd /var/www/kingpin
PORT=3000 node server.js

# allow port through firewall (Ubuntu UFW example)
sudo ufw allow 3000/tcp
```

- Mixed Content (page HTTPS but WS uses ws://) -> force WSS or enable TLS on site. Make sure `window.__MULTIPLAYER_SERVER_URL__` uses `wss://`.

- nginx 400 or 502 on WS -> verify nginx proxy upgrade headers and that the backend is reachable at 127.0.0.1:3000.

H. Helpful log commands for Eric (copy/paste)
--------------------------------------------
- Follow Node logs (systemd):
  - `sudo journalctl -u kingpin-server -f`
- Tail the game/world persistence file if exists:
  - `tail -f world-state.json`
- Show active processes:
  - `ps aux | grep node`

I. Final note for Eric
----------------------
- After deploying and configuring, open the game in a browser and copy the exact Console logs listed in section F and paste them back to the developer (or into a ticket). That will allow the developer to identify if the client is reaching the correct server URL and what error occurred.

If you want, I can also prepare a small `systemd-kingpin.service` file and a `Procfile` and commit them into the repo. Say "add service files" and I'll create them now.